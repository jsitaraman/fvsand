# include <stdio.h>
# include <stdlib.h>
# include <math.h>
# define REAL double
// J. Sitaraman
// last updated 06/13
// Penta diagonal solver

void pentSolve(REAL *a,REAL *b,REAL *c,REAL *d,REAL *e,REAL *f,int N)	{

   int i;
   REAL D0,D1,D2;

   // making diagonal 1.
   i=0;
   D0 = 1./c[i];
   d[i+1] *= D0;
   e[i+2] *= D0;
   f[i] *= D0;

   // making diagonal 1. and lower diagonal 0.
   i=1;
   D1 = b[i-1];
   D0 = 1./(c[i]-D1*d[i]);
   f[i] = (f[i]-D1*f[i-1])*D0; 
   d[i+1] = (d[i+1]-D1*e[i+1])*D0;
   e[i+2] *= D0;

   // making diaongal 1. and lower diagonals 0.
   for (i=2;i<=N-1;i++)	{
      D1 = a[i-2];
      D2 = (b[i-1] - a[i-2]*d[i-1]);
      D0 = 1./(c[i]-D2*d[i]-D1*e[i]);
      f[i] = (f[i]-D2*f[i-1]-D1*f[i-2])*D0; 
      if (i<=N-2)	{
         d[i+1] = (d[i+1]-D2*e[i+1])*D0;
         if (i<=N-3) e[i+2] = (e[i+2])*D0; 
      }
   }  

   // Backward Sweep
   i=N-2;
   D1=0.;
   D2=0.;
   for (i=N-2;i>=0;i--)	{
      D1 = d[i+1];
      if (i<N-2)  D2 = e[i+2];
      f[i] = f[i] - D1*f[i+1] - D2*f[i+2];
   }


}
//general 5*5 inversion
void matInv5(REAL *f1, REAL *f2, REAL *f3,REAL *f4,REAL *f5,int nq)  {


   int j,k;
   REAL det;
   REAL a00,a01,a02,a03,a04;
   REAL a10,a11,a12,a13,a14;
   REAL a20,a21,a22,a23,a24;
   REAL a30,a31,a32,a33,a34;
   REAL a40,a41,a42,a43,a44;

   a00=f1[0];
   a01=f1[1];
   a02=f1[2];
   a03=f1[3];
   a04=f1[4];
   a10=f2[0];
   a11=f2[1];
   a12=f2[2];
   a13=f2[3];
   a14=f2[4];
   a20=f3[0];
   a21=f3[1];
   a22=f3[2];
   a23=f3[3];
   a24=f3[4];
   a30=f4[0];
   a31=f4[1];
   a32=f4[2];
   a33=f4[3];
   a34=f4[4];
   a40=f5[0];
   a41=f5[1];
   a42=f5[2];
   a43=f5[3];
   a44=f5[4];
   det=a04*a13*a22*a31*a40 - a03*a14*a22*a31*a40 - 
     a04*a12*a23*a31*a40 + a02*a14*a23*a31*a40 + 
     a03*a12*a24*a31*a40 - a02*a13*a24*a31*a40 - 
     a04*a13*a21*a32*a40 + a03*a14*a21*a32*a40 + 
     a04*a11*a23*a32*a40 - a01*a14*a23*a32*a40 - 
     a03*a11*a24*a32*a40 + a01*a13*a24*a32*a40 + 
     a04*a12*a21*a33*a40 - a02*a14*a21*a33*a40 - 
     a04*a11*a22*a33*a40 + a01*a14*a22*a33*a40 + 
     a02*a11*a24*a33*a40 - a01*a12*a24*a33*a40 - 
     a03*a12*a21*a34*a40 + a02*a13*a21*a34*a40 + 
     a03*a11*a22*a34*a40 - a01*a13*a22*a34*a40 - 
     a02*a11*a23*a34*a40 + a01*a12*a23*a34*a40 - 
     a04*a13*a22*a30*a41 + a03*a14*a22*a30*a41 + 
     a04*a12*a23*a30*a41 - a02*a14*a23*a30*a41 - 
     a03*a12*a24*a30*a41 + a02*a13*a24*a30*a41 + 
     a04*a13*a20*a32*a41 - a03*a14*a20*a32*a41 - 
     a04*a10*a23*a32*a41 + a00*a14*a23*a32*a41 + 
     a03*a10*a24*a32*a41 - a00*a13*a24*a32*a41 - 
     a04*a12*a20*a33*a41 + a02*a14*a20*a33*a41 + 
     a04*a10*a22*a33*a41 - a00*a14*a22*a33*a41 - 
     a02*a10*a24*a33*a41 + a00*a12*a24*a33*a41 + 
     a03*a12*a20*a34*a41 - a02*a13*a20*a34*a41 - 
     a03*a10*a22*a34*a41 + a00*a13*a22*a34*a41 + 
     a02*a10*a23*a34*a41 - a00*a12*a23*a34*a41 + 
     a04*a13*a21*a30*a42 - a03*a14*a21*a30*a42 - 
     a04*a11*a23*a30*a42 + a01*a14*a23*a30*a42 + 
     a03*a11*a24*a30*a42 - a01*a13*a24*a30*a42 - 
     a04*a13*a20*a31*a42 + a03*a14*a20*a31*a42 + 
     a04*a10*a23*a31*a42 - a00*a14*a23*a31*a42 - 
     a03*a10*a24*a31*a42 + a00*a13*a24*a31*a42 + 
     a04*a11*a20*a33*a42 - a01*a14*a20*a33*a42 - 
     a04*a10*a21*a33*a42 + a00*a14*a21*a33*a42 + 
     a01*a10*a24*a33*a42 - a00*a11*a24*a33*a42 - 
     a03*a11*a20*a34*a42 + a01*a13*a20*a34*a42 + 
     a03*a10*a21*a34*a42 - a00*a13*a21*a34*a42 - 
     a01*a10*a23*a34*a42 + a00*a11*a23*a34*a42 - 
     a04*a12*a21*a30*a43 + a02*a14*a21*a30*a43 + 
     a04*a11*a22*a30*a43 - a01*a14*a22*a30*a43 - 
     a02*a11*a24*a30*a43 + a01*a12*a24*a30*a43 + 
     a04*a12*a20*a31*a43 - a02*a14*a20*a31*a43 - 
     a04*a10*a22*a31*a43 + a00*a14*a22*a31*a43 + 
     a02*a10*a24*a31*a43 - a00*a12*a24*a31*a43 - 
     a04*a11*a20*a32*a43 + a01*a14*a20*a32*a43 + 
     a04*a10*a21*a32*a43 - a00*a14*a21*a32*a43 - 
     a01*a10*a24*a32*a43 + a00*a11*a24*a32*a43 + 
     a02*a11*a20*a34*a43 - a01*a12*a20*a34*a43 - 
     a02*a10*a21*a34*a43 + a00*a12*a21*a34*a43 + 
     a01*a10*a22*a34*a43 - a00*a11*a22*a34*a43 + 
     a03*a12*a21*a30*a44 - a02*a13*a21*a30*a44 - 
     a03*a11*a22*a30*a44 + a01*a13*a22*a30*a44 + 
     a02*a11*a23*a30*a44 - a01*a12*a23*a30*a44 - 
     a03*a12*a20*a31*a44 + a02*a13*a20*a31*a44 + 
     a03*a10*a22*a31*a44 - a00*a13*a22*a31*a44 - 
     a02*a10*a23*a31*a44 + a00*a12*a23*a31*a44 + 
     a03*a11*a20*a32*a44 - a01*a13*a20*a32*a44 - 
     a03*a10*a21*a32*a44 + a00*a13*a21*a32*a44 + 
     a01*a10*a23*a32*a44 - a00*a11*a23*a32*a44 - 
     a02*a11*a20*a33*a44 + a01*a12*a20*a33*a44 + 
     a02*a10*a21*a33*a44 - a00*a12*a21*a33*a44 - 
     a01*a10*a22*a33*a44 + a00*a11*a22*a33*a44;
   if (det==0) det=1.e-6;

   f1[0] =a14*a23*a32*a41 - a13*a24*a32*a41 - a14*a22*a33*a41 + 
     a12*a24*a33*a41 + a13*a22*a34*a41 - a12*a23*a34*a41 - 
     a14*a23*a31*a42 + a13*a24*a31*a42 + a14*a21*a33*a42 - 
     a11*a24*a33*a42 - a13*a21*a34*a42 + a11*a23*a34*a42 + 
     a14*a22*a31*a43 - a12*a24*a31*a43 - a14*a21*a32*a43 + 
     a11*a24*a32*a43 + a12*a21*a34*a43 - a11*a22*a34*a43 - 
     a13*a22*a31*a44 + a12*a23*a31*a44 + a13*a21*a32*a44 - 
     a11*a23*a32*a44 - a12*a21*a33*a44 + a11*a22*a33*a44;
   f1[1] =-(a04*a23*a32*a41) + a03*a24*a32*a41 + a04*a22*a33*a41 - 
     a02*a24*a33*a41 - a03*a22*a34*a41 + a02*a23*a34*a41 + 
     a04*a23*a31*a42 - a03*a24*a31*a42 - a04*a21*a33*a42 + 
     a01*a24*a33*a42 + a03*a21*a34*a42 - a01*a23*a34*a42 - 
     a04*a22*a31*a43 + a02*a24*a31*a43 + a04*a21*a32*a43 - 
     a01*a24*a32*a43 - a02*a21*a34*a43 + a01*a22*a34*a43 + 
     a03*a22*a31*a44 - a02*a23*a31*a44 - a03*a21*a32*a44 + 
     a01*a23*a32*a44 + a02*a21*a33*a44 - a01*a22*a33*a44;
   f1[2] =a04*a13*a32*a41 - a03*a14*a32*a41 - a04*a12*a33*a41 + 
     a02*a14*a33*a41 + a03*a12*a34*a41 - a02*a13*a34*a41 - 
     a04*a13*a31*a42 + a03*a14*a31*a42 + a04*a11*a33*a42 - 
     a01*a14*a33*a42 - a03*a11*a34*a42 + a01*a13*a34*a42 + 
     a04*a12*a31*a43 - a02*a14*a31*a43 - a04*a11*a32*a43 + 
     a01*a14*a32*a43 + a02*a11*a34*a43 - a01*a12*a34*a43 - 
     a03*a12*a31*a44 + a02*a13*a31*a44 + a03*a11*a32*a44 - 
     a01*a13*a32*a44 - a02*a11*a33*a44 + a01*a12*a33*a44;
   f1[3] =-(a04*a13*a22*a41) + a03*a14*a22*a41 + a04*a12*a23*a41 - 
     a02*a14*a23*a41 - a03*a12*a24*a41 + a02*a13*a24*a41 + 
     a04*a13*a21*a42 - a03*a14*a21*a42 - a04*a11*a23*a42 + 
     a01*a14*a23*a42 + a03*a11*a24*a42 - a01*a13*a24*a42 - 
     a04*a12*a21*a43 + a02*a14*a21*a43 + a04*a11*a22*a43 - 
     a01*a14*a22*a43 - a02*a11*a24*a43 + a01*a12*a24*a43 + 
     a03*a12*a21*a44 - a02*a13*a21*a44 - a03*a11*a22*a44 + 
     a01*a13*a22*a44 + a02*a11*a23*a44 - a01*a12*a23*a44;
   f1[4] =a04*a13*a22*a31 - a03*a14*a22*a31 - a04*a12*a23*a31 + 
     a02*a14*a23*a31 + a03*a12*a24*a31 - a02*a13*a24*a31 - 
     a04*a13*a21*a32 + a03*a14*a21*a32 + a04*a11*a23*a32 - 
     a01*a14*a23*a32 - a03*a11*a24*a32 + a01*a13*a24*a32 + 
     a04*a12*a21*a33 - a02*a14*a21*a33 - a04*a11*a22*a33 + 
     a01*a14*a22*a33 + a02*a11*a24*a33 - a01*a12*a24*a33 - 
     a03*a12*a21*a34 + a02*a13*a21*a34 + a03*a11*a22*a34 - 
     a01*a13*a22*a34 - a02*a11*a23*a34 + a01*a12*a23*a34;
   f2[0] =-(a14*a23*a32*a40) + a13*a24*a32*a40 + a14*a22*a33*a40 - 
     a12*a24*a33*a40 - a13*a22*a34*a40 + a12*a23*a34*a40 + 
     a14*a23*a30*a42 - a13*a24*a30*a42 - a14*a20*a33*a42 + 
     a10*a24*a33*a42 + a13*a20*a34*a42 - a10*a23*a34*a42 - 
     a14*a22*a30*a43 + a12*a24*a30*a43 + a14*a20*a32*a43 - 
     a10*a24*a32*a43 - a12*a20*a34*a43 + a10*a22*a34*a43 + 
     a13*a22*a30*a44 - a12*a23*a30*a44 - a13*a20*a32*a44 + 
     a10*a23*a32*a44 + a12*a20*a33*a44 - a10*a22*a33*a44;
   f2[1] =a04*a23*a32*a40 - a03*a24*a32*a40 - a04*a22*a33*a40 + 
     a02*a24*a33*a40 + a03*a22*a34*a40 - a02*a23*a34*a40 - 
     a04*a23*a30*a42 + a03*a24*a30*a42 + a04*a20*a33*a42 - 
     a00*a24*a33*a42 - a03*a20*a34*a42 + a00*a23*a34*a42 + 
     a04*a22*a30*a43 - a02*a24*a30*a43 - a04*a20*a32*a43 + 
     a00*a24*a32*a43 + a02*a20*a34*a43 - a00*a22*a34*a43 - 
     a03*a22*a30*a44 + a02*a23*a30*a44 + a03*a20*a32*a44 - 
     a00*a23*a32*a44 - a02*a20*a33*a44 + a00*a22*a33*a44;
   f2[2] =-(a04*a13*a32*a40) + a03*a14*a32*a40 + a04*a12*a33*a40 - 
     a02*a14*a33*a40 - a03*a12*a34*a40 + a02*a13*a34*a40 + 
     a04*a13*a30*a42 - a03*a14*a30*a42 - a04*a10*a33*a42 + 
     a00*a14*a33*a42 + a03*a10*a34*a42 - a00*a13*a34*a42 - 
     a04*a12*a30*a43 + a02*a14*a30*a43 + a04*a10*a32*a43 - 
     a00*a14*a32*a43 - a02*a10*a34*a43 + a00*a12*a34*a43 + 
     a03*a12*a30*a44 - a02*a13*a30*a44 - a03*a10*a32*a44 + 
     a00*a13*a32*a44 + a02*a10*a33*a44 - a00*a12*a33*a44;
   f2[3] =a04*a13*a22*a40 - a03*a14*a22*a40 - a04*a12*a23*a40 + 
     a02*a14*a23*a40 + a03*a12*a24*a40 - a02*a13*a24*a40 - 
     a04*a13*a20*a42 + a03*a14*a20*a42 + a04*a10*a23*a42 - 
     a00*a14*a23*a42 - a03*a10*a24*a42 + a00*a13*a24*a42 + 
     a04*a12*a20*a43 - a02*a14*a20*a43 - a04*a10*a22*a43 + 
     a00*a14*a22*a43 + a02*a10*a24*a43 - a00*a12*a24*a43 - 
     a03*a12*a20*a44 + a02*a13*a20*a44 + a03*a10*a22*a44 - 
     a00*a13*a22*a44 - a02*a10*a23*a44 + a00*a12*a23*a44;
   f2[4] =-(a04*a13*a22*a30) + a03*a14*a22*a30 + a04*a12*a23*a30 - 
     a02*a14*a23*a30 - a03*a12*a24*a30 + a02*a13*a24*a30 + 
     a04*a13*a20*a32 - a03*a14*a20*a32 - a04*a10*a23*a32 + 
     a00*a14*a23*a32 + a03*a10*a24*a32 - a00*a13*a24*a32 - 
     a04*a12*a20*a33 + a02*a14*a20*a33 + a04*a10*a22*a33 - 
     a00*a14*a22*a33 - a02*a10*a24*a33 + a00*a12*a24*a33 + 
     a03*a12*a20*a34 - a02*a13*a20*a34 - a03*a10*a22*a34 + 
     a00*a13*a22*a34 + a02*a10*a23*a34 - a00*a12*a23*a34;
   f3[0] =a14*a23*a31*a40 - a13*a24*a31*a40 - a14*a21*a33*a40 + 
     a11*a24*a33*a40 + a13*a21*a34*a40 - a11*a23*a34*a40 - 
     a14*a23*a30*a41 + a13*a24*a30*a41 + a14*a20*a33*a41 - 
     a10*a24*a33*a41 - a13*a20*a34*a41 + a10*a23*a34*a41 + 
     a14*a21*a30*a43 - a11*a24*a30*a43 - a14*a20*a31*a43 + 
     a10*a24*a31*a43 + a11*a20*a34*a43 - a10*a21*a34*a43 - 
     a13*a21*a30*a44 + a11*a23*a30*a44 + a13*a20*a31*a44 - 
     a10*a23*a31*a44 - a11*a20*a33*a44 + a10*a21*a33*a44;
   f3[1] =-(a04*a23*a31*a40) + a03*a24*a31*a40 + a04*a21*a33*a40 - 
     a01*a24*a33*a40 - a03*a21*a34*a40 + a01*a23*a34*a40 + 
     a04*a23*a30*a41 - a03*a24*a30*a41 - a04*a20*a33*a41 + 
     a00*a24*a33*a41 + a03*a20*a34*a41 - a00*a23*a34*a41 - 
     a04*a21*a30*a43 + a01*a24*a30*a43 + a04*a20*a31*a43 - 
     a00*a24*a31*a43 - a01*a20*a34*a43 + a00*a21*a34*a43 + 
     a03*a21*a30*a44 - a01*a23*a30*a44 - a03*a20*a31*a44 + 
     a00*a23*a31*a44 + a01*a20*a33*a44 - a00*a21*a33*a44;
   f3[2] =a04*a13*a31*a40 - a03*a14*a31*a40 - a04*a11*a33*a40 + 
     a01*a14*a33*a40 + a03*a11*a34*a40 - a01*a13*a34*a40 - 
     a04*a13*a30*a41 + a03*a14*a30*a41 + a04*a10*a33*a41 - 
     a00*a14*a33*a41 - a03*a10*a34*a41 + a00*a13*a34*a41 + 
     a04*a11*a30*a43 - a01*a14*a30*a43 - a04*a10*a31*a43 + 
     a00*a14*a31*a43 + a01*a10*a34*a43 - a00*a11*a34*a43 - 
     a03*a11*a30*a44 + a01*a13*a30*a44 + a03*a10*a31*a44 - 
     a00*a13*a31*a44 - a01*a10*a33*a44 + a00*a11*a33*a44;
   f3[3] =-(a04*a13*a21*a40) + a03*a14*a21*a40 + a04*a11*a23*a40 - 
     a01*a14*a23*a40 - a03*a11*a24*a40 + a01*a13*a24*a40 + 
     a04*a13*a20*a41 - a03*a14*a20*a41 - a04*a10*a23*a41 + 
     a00*a14*a23*a41 + a03*a10*a24*a41 - a00*a13*a24*a41 - 
     a04*a11*a20*a43 + a01*a14*a20*a43 + a04*a10*a21*a43 - 
     a00*a14*a21*a43 - a01*a10*a24*a43 + a00*a11*a24*a43 + 
     a03*a11*a20*a44 - a01*a13*a20*a44 - a03*a10*a21*a44 + 
     a00*a13*a21*a44 + a01*a10*a23*a44 - a00*a11*a23*a44;
   f3[4] =a04*a13*a21*a30 - a03*a14*a21*a30 - a04*a11*a23*a30 + 
     a01*a14*a23*a30 + a03*a11*a24*a30 - a01*a13*a24*a30 - 
     a04*a13*a20*a31 + a03*a14*a20*a31 + a04*a10*a23*a31 - 
     a00*a14*a23*a31 - a03*a10*a24*a31 + a00*a13*a24*a31 + 
     a04*a11*a20*a33 - a01*a14*a20*a33 - a04*a10*a21*a33 + 
     a00*a14*a21*a33 + a01*a10*a24*a33 - a00*a11*a24*a33 - 
     a03*a11*a20*a34 + a01*a13*a20*a34 + a03*a10*a21*a34 - 
     a00*a13*a21*a34 - a01*a10*a23*a34 + a00*a11*a23*a34;
   f4[0] =-(a14*a22*a31*a40) + a12*a24*a31*a40 + a14*a21*a32*a40 - 
     a11*a24*a32*a40 - a12*a21*a34*a40 + a11*a22*a34*a40 + 
     a14*a22*a30*a41 - a12*a24*a30*a41 - a14*a20*a32*a41 + 
     a10*a24*a32*a41 + a12*a20*a34*a41 - a10*a22*a34*a41 - 
     a14*a21*a30*a42 + a11*a24*a30*a42 + a14*a20*a31*a42 - 
     a10*a24*a31*a42 - a11*a20*a34*a42 + a10*a21*a34*a42 + 
     a12*a21*a30*a44 - a11*a22*a30*a44 - a12*a20*a31*a44 + 
     a10*a22*a31*a44 + a11*a20*a32*a44 - a10*a21*a32*a44;
   f4[1] =a04*a22*a31*a40 - a02*a24*a31*a40 - a04*a21*a32*a40 + 
     a01*a24*a32*a40 + a02*a21*a34*a40 - a01*a22*a34*a40 - 
     a04*a22*a30*a41 + a02*a24*a30*a41 + a04*a20*a32*a41 - 
     a00*a24*a32*a41 - a02*a20*a34*a41 + a00*a22*a34*a41 + 
     a04*a21*a30*a42 - a01*a24*a30*a42 - a04*a20*a31*a42 + 
     a00*a24*a31*a42 + a01*a20*a34*a42 - a00*a21*a34*a42 - 
     a02*a21*a30*a44 + a01*a22*a30*a44 + a02*a20*a31*a44 - 
     a00*a22*a31*a44 - a01*a20*a32*a44 + a00*a21*a32*a44;
   f4[2] =-(a04*a12*a31*a40) + a02*a14*a31*a40 + a04*a11*a32*a40 - 
     a01*a14*a32*a40 - a02*a11*a34*a40 + a01*a12*a34*a40 + 
     a04*a12*a30*a41 - a02*a14*a30*a41 - a04*a10*a32*a41 + 
     a00*a14*a32*a41 + a02*a10*a34*a41 - a00*a12*a34*a41 - 
     a04*a11*a30*a42 + a01*a14*a30*a42 + a04*a10*a31*a42 - 
     a00*a14*a31*a42 - a01*a10*a34*a42 + a00*a11*a34*a42 + 
     a02*a11*a30*a44 - a01*a12*a30*a44 - a02*a10*a31*a44 + 
     a00*a12*a31*a44 + a01*a10*a32*a44 - a00*a11*a32*a44;
   f4[3] =a04*a12*a21*a40 - a02*a14*a21*a40 - a04*a11*a22*a40 + 
     a01*a14*a22*a40 + a02*a11*a24*a40 - a01*a12*a24*a40 - 
     a04*a12*a20*a41 + a02*a14*a20*a41 + a04*a10*a22*a41 - 
     a00*a14*a22*a41 - a02*a10*a24*a41 + a00*a12*a24*a41 + 
     a04*a11*a20*a42 - a01*a14*a20*a42 - a04*a10*a21*a42 + 
     a00*a14*a21*a42 + a01*a10*a24*a42 - a00*a11*a24*a42 - 
     a02*a11*a20*a44 + a01*a12*a20*a44 + a02*a10*a21*a44 - 
     a00*a12*a21*a44 - a01*a10*a22*a44 + a00*a11*a22*a44;
   f4[4] =-(a04*a12*a21*a30) + a02*a14*a21*a30 + a04*a11*a22*a30 - 
     a01*a14*a22*a30 - a02*a11*a24*a30 + a01*a12*a24*a30 + 
     a04*a12*a20*a31 - a02*a14*a20*a31 - a04*a10*a22*a31 + 
     a00*a14*a22*a31 + a02*a10*a24*a31 - a00*a12*a24*a31 - 
     a04*a11*a20*a32 + a01*a14*a20*a32 + a04*a10*a21*a32 - 
     a00*a14*a21*a32 - a01*a10*a24*a32 + a00*a11*a24*a32 + 
     a02*a11*a20*a34 - a01*a12*a20*a34 - a02*a10*a21*a34 + 
     a00*a12*a21*a34 + a01*a10*a22*a34 - a00*a11*a22*a34;
   f5[0] =a13*a22*a31*a40 - a12*a23*a31*a40 - a13*a21*a32*a40 + 
     a11*a23*a32*a40 + a12*a21*a33*a40 - a11*a22*a33*a40 - 
     a13*a22*a30*a41 + a12*a23*a30*a41 + a13*a20*a32*a41 - 
     a10*a23*a32*a41 - a12*a20*a33*a41 + a10*a22*a33*a41 + 
     a13*a21*a30*a42 - a11*a23*a30*a42 - a13*a20*a31*a42 + 
     a10*a23*a31*a42 + a11*a20*a33*a42 - a10*a21*a33*a42 - 
     a12*a21*a30*a43 + a11*a22*a30*a43 + a12*a20*a31*a43 - 
     a10*a22*a31*a43 - a11*a20*a32*a43 + a10*a21*a32*a43;
   f5[1] =-(a03*a22*a31*a40) + a02*a23*a31*a40 + a03*a21*a32*a40 - 
     a01*a23*a32*a40 - a02*a21*a33*a40 + a01*a22*a33*a40 + 
     a03*a22*a30*a41 - a02*a23*a30*a41 - a03*a20*a32*a41 + 
     a00*a23*a32*a41 + a02*a20*a33*a41 - a00*a22*a33*a41 - 
     a03*a21*a30*a42 + a01*a23*a30*a42 + a03*a20*a31*a42 - 
     a00*a23*a31*a42 - a01*a20*a33*a42 + a00*a21*a33*a42 + 
     a02*a21*a30*a43 - a01*a22*a30*a43 - a02*a20*a31*a43 + 
     a00*a22*a31*a43 + a01*a20*a32*a43 - a00*a21*a32*a43;
   f5[2] =a03*a12*a31*a40 - a02*a13*a31*a40 - a03*a11*a32*a40 + 
     a01*a13*a32*a40 + a02*a11*a33*a40 - a01*a12*a33*a40 - 
     a03*a12*a30*a41 + a02*a13*a30*a41 + a03*a10*a32*a41 - 
     a00*a13*a32*a41 - a02*a10*a33*a41 + a00*a12*a33*a41 + 
     a03*a11*a30*a42 - a01*a13*a30*a42 - a03*a10*a31*a42 + 
     a00*a13*a31*a42 + a01*a10*a33*a42 - a00*a11*a33*a42 - 
     a02*a11*a30*a43 + a01*a12*a30*a43 + a02*a10*a31*a43 - 
     a00*a12*a31*a43 - a01*a10*a32*a43 + a00*a11*a32*a43;
   f5[3] =-(a03*a12*a21*a40) + a02*a13*a21*a40 + a03*a11*a22*a40 - 
     a01*a13*a22*a40 - a02*a11*a23*a40 + a01*a12*a23*a40 + 
     a03*a12*a20*a41 - a02*a13*a20*a41 - a03*a10*a22*a41 + 
     a00*a13*a22*a41 + a02*a10*a23*a41 - a00*a12*a23*a41 - 
     a03*a11*a20*a42 + a01*a13*a20*a42 + a03*a10*a21*a42 - 
     a00*a13*a21*a42 - a01*a10*a23*a42 + a00*a11*a23*a42 + 
     a02*a11*a20*a43 - a01*a12*a20*a43 - a02*a10*a21*a43 + 
     a00*a12*a21*a43 + a01*a10*a22*a43 - a00*a11*a22*a43;
   f5[4] =a03*a12*a21*a30 - a02*a13*a21*a30 - a03*a11*a22*a30 + 
     a01*a13*a22*a30 + a02*a11*a23*a30 - a01*a12*a23*a30 - 
     a03*a12*a20*a31 + a02*a13*a20*a31 + a03*a10*a22*a31 - 
     a00*a13*a22*a31 - a02*a10*a23*a31 + a00*a12*a23*a31 + 
     a03*a11*a20*a32 - a01*a13*a20*a32 - a03*a10*a21*a32 + 
     a00*a13*a21*a32 + a01*a10*a23*a32 - a00*a11*a23*a32 - 
     a02*a11*a20*a33 + a01*a12*a20*a33 + a02*a10*a21*a33 - 
     a00*a12*a21*a33 - a01*a10*a22*a33 + a00*a11*a22*a33;
   for (j=0;j<nq;j++)  {
      f1[j]/=det;
      f2[j]/=det;
      f3[j]/=det;
      f4[j]/=det;
      f5[j]/=det;
   }
}

//tridiagonal block inversion
// nq = 5
void blockInv(REAL ***a,REAL ***b, REAL ***c,REAL **f, int N,int nq)  {

   int i,j,k,l;
   REAL f1[5],f2[5],f3[5],f4[5],f5[5];
   REAL t[5][5];
   i=0;
   for (i=0;i<N;i++)  {
      if (i!=0) {
         // b(i) = b(i) - a(i-1)*c(i)
         for (k=0;k<nq;k++)  {
            for (j=0;j<nq;j++)  {
	       for (l=0;l<nq;l++)  {
                  b[i][k][j]-=a[i-1][k][l]*c[i][l][j];
	       }
            }
         }
         // f(i) = f(i) - a(i-1)*f(i-1)
         for (k=0;k<nq;k++)  {
            for (j=0;j<nq;j++)  {
               f[i][k]-=a[i-1][k][j]*f[i-1][j];
            }
         }
      }
      for (j=0;j<nq;j++)  {
         f1[j]=b[i][0][j];
         f2[j]=b[i][1][j];
         f3[j]=b[i][2][j];
         f4[j]=b[i][3][j];
         f5[j]=b[i][4][j];
      }
      matInv5(f1,f2,f3,f4,f5,nq);
      // f's store inverse of b(i)
      for (k=0;k<nq;k++)  {
         t[k][0]=0.;
      }
      //f(i) = Inv(b(i))* f(i)
      for (l=0;l<nq;l++)  {
         t[0][0]+=f1[l]*f[i][l];
         t[1][0]+=f2[l]*f[i][l];
         t[2][0]+=f3[l]*f[i][l];
         t[3][0]+=f4[l]*f[i][l];
         t[4][0]+=f5[l]*f[i][l];
      }
      for (l=0;l<nq;l++)  {
	 f[i][l]=t[l][0];
      }
      if (i!=N-1) {
         // c(i+1) =  Inv(b(i)) *c(i+1)
         for (j=0;j<nq;j++)  {
            for (k=0;k<nq;k++)  {
               t[k][j]=0.;
            }
            for (l=0;l<nq;l++)  {
               t[0][j]+=f1[l]*c[i+1][l][j];
               t[1][j]+=f2[l]*c[i+1][l][j];
               t[2][j]+=f3[l]*c[i+1][l][j];
               t[3][j]+=f4[l]*c[i+1][l][j];
               t[4][j]+=f5[l]*c[i+1][l][j];
            }
         }
         for (j=0;j<nq;j++) {
	    for (k=0;k<nq;k++)  {
	       c[i+1][j][k]=t[j][k];
	    }
         }
      }
   }
   //backward sweep
   for (i=N-2;i>=0;i--)  {
      // f(i) = f(i) - c(i+1)*f(i+1)
      for (k=0;k<nq;k++)  {
         for (j=0;j<nq;j++)  {
            f[i][k]-=c[i+1][k][j]*f[i+1][j];
         }
      }
   }
}
//tridiagonal block inversion
// nq = 5
void blockTridag(double ***a,double ***b, double ***c,double **f, int N,int nq)  
{
   int i,j,k,l;   

   double b11,b21,b22,b31,b32,b33,b41,b42,b43,b44,b51,b52,b53,b54,b55;
   double u12,u13,u14,u15,u23,u24,u25,u34,u35,u44,u45;
   double d1,d2,d3,d4,d5;
   double c1,c2,c3,c4,c5;
   double t[5][5];

   i=0;
   for (i=0;i<N;i++)  
   {
     if (i!=0) 
     {
       // b(i) = b(i) - a(i)*c(i-1)
       for (k=0;k<nq;k++)  
       {
          for (j=0;j<nq;j++)  
          {
	          for (l=0;l<nq;l++)  
	          {
              b[i][k][j]-=a[i][k][l]*c[i-1][l][j];
	          }
            f[i][k]-=a[i][k][j]*f[i-1][j];
          }
       }
       
       //for (k=0;k<nq;k++)  
       //{
       //  for (j=0;j<nq;j++)  
       //  {
       //    f[i][k]-=a[i][k][j]*f[i-1][j];
       //  }
       //}
     }
     // decompose b(i) into L and U
     b11=1./b[i][0][0];
     u12=b[i][0][1]*b11;
     u13=b[i][0][2]*b11;
     u14=b[i][0][3]*b11;
     u15=b[i][0][4]*b11;
     b21=b[i][1][0];
     b22=1./(b[i][1][1]-b21*u12);
     u23=(b[i][1][2]-b21*u13)*b22;
     u24=(b[i][1][3]-b21*u14)*b22;
     u25=(b[i][1][4]-b21*u15)*b22;
     b31=b[i][2][0];
     b32=b[i][2][1]-b31*u12;
     b33=1./(b[i][2][2]-b31*u13-b32*u23);
     u34=(b[i][2][3]-b31*u14-b32*u24)*b33;
     u35=(b[i][2][4]-b31*u15-b32*u25)*b33;
     b41=b[i][3][0];
     b42=b[i][3][1]-b41*u12;
     b43=b[i][3][2]-b41*u13-b42*u23;
     b44=1./(b[i][3][3]-b41*u14-b42*u24-b43*u34);
     u45=(b[i][3][4]-b41*u15-b42*u25-b43*u35)*b44;
     b51=b[i][4][0];
     b52=b[i][4][1]-b51*u12;
     b53=b[i][4][2]-b51*u13-b52*u23;
     b54=b[i][4][3]-b51*u14-b52*u24-b53*u34;
     b55=1./(b[i][4][4]-b51*u15-b52*u25-b53*u35-b54*u45);
     //f(i) = Inv(b(i))* f(i)
     d1=f[i][0]*b11;
     d2=(f[i][1]-b21*d1)*b22;
     d3=(f[i][2]-b31*d1-b32*d2)*b33;
     d4=(f[i][3]-b41*d1-b42*d2-b43*d3)*b44;
     d5=(f[i][4]-b51*d1-b52*d2-b53*d3-b54*d4)*b55;

     f[i][4]=d5;
     f[i][3]=d4-u45*d5;
     f[i][2]=d3-u34*f[i][3]-u35*d5;
     f[i][1]=d2-u23*f[i][2]-u24*f[i][3]-u25*d5;
     f[i][0]=d1-u12*f[i][1]-u13*f[i][2]-u14*f[i][3]-u15*d5;

     if (i!=N-1) 
     {
     // c(i) =  Inv(b(i)) *c(i)
       for (j=0;j<nq;j++)  
       {
	       c1=c[i][0][j]*b11;
	       c2=(c[i][1][j]-b21*c1)*b22;
	       c3=(c[i][2][j]-b31*c1-b32*c2)*b33;
	       c4=(c[i][3][j]-b41*c1-b42*c2-b43*c3)*b44;
	       c5=(c[i][4][j]-b51*c1-b52*c2-b53*c3-b54*c4)*b55;

	       c[i][4][j]=c5;
	       c[i][3][j]=c4-u45*c5;
	       c[i][2][j]=c3-u34*c[i][3][j]-u35*c5;
	       c[i][1][j]=c2-u23*c[i][2][j]-u24*c[i][3][j]-u25*c5;
	       c[i][0][j]=c1-u12*c[i][1][j]-u13*c[i][2][j]-u14*c[i][3][j]-u15*c5;
       }
     }
   }
   //backward sweep
   for (i=N-2;i>=0;i--)  
   {
      // f(i) = f(i) - c(i+1)*f(i+1)
     for (k=0;k<nq;k++)  
     {
       for (j=0;j<nq;j++)  
       {
         f[i][k]-=c[i][k][j]*f[i+1][j];
       }
     }
   }
}

//tridiagonal block inversion
// nq = 5
void blockTridagPeriodic(double ***a,double ***b, double ***c,double **f, int N,int nq)  
{
   int i,j,k,l;

   double b11,b21,b22,b31,b32,b33,b41,b42,b43,b44,b51,b52,b53,b54,b55;
   double u12,u13,u14,u15,u23,u24,u25,u34,u35,u44,u45;
   double d1,d2,d3,d4,d5;
   double c1,c2,c3,c4,c5;
   double a1,a2,a3,a4,a5;
   double t[5][5];

   i=0;
   for (i=0;i<N;i++)  
   {
      if (i!=0) 
      {
         // b(i) = b(i) - a(i)*c(i-1)
         for (k=0;k<nq;k++)  
         {
            for (j=0;j<nq;j++)  
            {
	            for (l=0;l<nq;l++)  
	            {
                b[i][k][j]-=a[i][k][l]*c[i-1][l][j];
	            }
            }
         }
         // f(i) = f(i) - a(i)*f(i-1)
         for (k=0;k<nq;k++)  
         {
            for (j=0;j<nq;j++)  
            {
               f[i][k]-=a[i][k][j]*f[i-1][j];
            }
         }

	       for(k=0;k<nq;k++)
	         for(j=0;j<nq;j++)
	           t[k][j]=0;
	       // a(i) = -a(i)*a(i-1)
	       for(k=0;k<nq;k++)
	       {
	         for(j=0;j<nq;j++)
	         {
	           for(l=0;l<nq;l++)
	           {
	             t[k][j]-=a[i][k][l]*a[i-1][l][j];
	           }
	         }
	       }

	       for(k=0;k<nq;k++)
	         for(j=0;j<nq;j++)
	           a[i][k][j]=t[k][j];	 
      }
      
      // decompose b(i) into L and U
      b11=1./b[i][0][0];
      u12=b[i][0][1]*b11;
      u13=b[i][0][2]*b11;
      u14=b[i][0][3]*b11;
      u15=b[i][0][4]*b11;
      b21=b[i][1][0];
      b22=1./(b[i][1][1]-b21*u12);
      u23=(b[i][1][2]-b21*u13)*b22;
      u24=(b[i][1][3]-b21*u14)*b22;
      u25=(b[i][1][4]-b21*u15)*b22;
      b31=b[i][2][0];
      b32=b[i][2][1]-b31*u12;
      b33=1./(b[i][2][2]-b31*u13-b32*u23);
      u34=(b[i][2][3]-b31*u14-b32*u24)*b33;
      u35=(b[i][2][4]-b31*u15-b32*u25)*b33;
      b41=b[i][3][0];
      b42=b[i][3][1]-b41*u12;
      b43=b[i][3][2]-b41*u13-b42*u23;
      b44=1./(b[i][3][3]-b41*u14-b42*u24-b43*u34);
      u45=(b[i][3][4]-b41*u15-b42*u25-b43*u35)*b44;
      b51=b[i][4][0];
      b52=b[i][4][1]-b51*u12;
      b53=b[i][4][2]-b51*u13-b52*u23;
      b54=b[i][4][3]-b51*u14-b52*u24-b53*u34;
      b55=1./(b[i][4][4]-b51*u15-b52*u25-b53*u35-b54*u45);
      //f(i) = Inv(b(i))* f(i)
      d1=f[i][0]*b11;
      d2=(f[i][1]-b21*d1)*b22;
      d3=(f[i][2]-b31*d1-b32*d2)*b33;
      d4=(f[i][3]-b41*d1-b42*d2-b43*d3)*b44;
      d5=(f[i][4]-b51*d1-b52*d2-b53*d3-b54*d4)*b55;

      f[i][4]=d5;
      f[i][3]=d4-u45*d5;
      f[i][2]=d3-u34*f[i][3]-u35*d5;
      f[i][1]=d2-u23*f[i][2]-u24*f[i][3]-u25*d5;
      f[i][0]=d1-u12*f[i][1]-u13*f[i][2]-u14*f[i][3]-u15*d5;

      if (i!= N-2) 
      {
        // c(i) =  Inv(b(i)) *c(i)
	// a(i) = Inv(b(i))*a(i)
         for (j=0;j<nq;j++)  
         {
	         c1=c[i][0][j]*b11;
	         c2=(c[i][1][j]-b21*c1)*b22;
	         c3=(c[i][2][j]-b31*c1-b32*c2)*b33;
	         c4=(c[i][3][j]-b41*c1-b42*c2-b43*c3)*b44;
	         c5=(c[i][4][j]-b51*c1-b52*c2-b53*c3-b54*c4)*b55;

	         c[i][4][j]=c5;
	         c[i][3][j]=c4-u45*c5;
	         c[i][2][j]=c3-u34*c[i][3][j]-u35*c5;
	         c[i][1][j]=c2-u23*c[i][2][j]-u24*c[i][3][j]-u25*c5;
	         c[i][0][j]=c1-u12*c[i][1][j]-u13*c[i][2][j]-u14*c[i][3][j]-u15*c5;
	         
	         a1=a[i][0][j]*b11;
	         a2=(a[i][1][j]-b21*a1)*b22;
	         a3=(a[i][2][j]-b31*a1-b32*a2)*b33;
	         a4=(a[i][3][j]-b41*a1-b42*a2-b43*a3)*b44;
	         a5=(a[i][4][j]-b51*a1-b52*a2-b53*a3-b54*a4)*b55;

	         a[i][4][j]=a5;
	         a[i][3][j]=a4-u45*a5;
	         a[i][2][j]=a3-u34*a[i][3][j]-u35*a5;
	         a[i][1][j]=a2-u23*a[i][2][j]-u24*a[i][3][j]-u25*a5;
	         a[i][0][j]=a1-u12*a[i][1][j]-u13*a[i][2][j]-u14*a[i][3][j]-u15*a5;
         }
      }
      if (i==N-2) 
      {	      
	      for(j=0;j<nq;j++)
	        for(k=0;k<nq;k++)
	         c[i][j][k]+=a[i][j][k];
	      for (j=0;j<nq;j++)  
	      {
	        c1=c[i][0][j]*b11;
	        c2=(c[i][1][j]-b21*c1)*b22;
	        c3=(c[i][2][j]-b31*c1-b32*c2)*b33;
	        c4=(c[i][3][j]-b41*c1-b42*c2-b43*c3)*b44;
	        c5=(c[i][4][j]-b51*c1-b52*c2-b53*c3-b54*c4)*b55;

	        c[i][4][j]=c5;
	        c[i][3][j]=c4-u45*c5;
	        c[i][2][j]=c3-u34*c[i][3][j]-u35*c5;
	        c[i][1][j]=c2-u23*c[i][2][j]-u24*c[i][3][j]-u25*c5;
	        c[i][0][j]=c1-u12*c[i][1][j]-u13*c[i][2][j]-u14*c[i][3][j]-u15*c5;
	      }
	      for(k=0;k<nq;k++)
	        for(j=0;j<nq;j++)
	          a[i][k][j]=c[i][k][j];
      }
   }

   i=N-1;
   
   for (j=0;j<nq;j++)
   {     
     for (k=0;k<nq;k++)
     {
       if (j==k)
       {
	       b[i][j][k]=1.0;
       }
       else
       {
	       b[i][j][k]=0.0;
       } 
     }
   }

   for(i=0;i<N-1;i++)
   {
     for(k=0;k<nq;k++)
	     for(j=0;j<nq;j++)
	       t[k][j]=0;

     for(k=0;k<nq;k++)
	     for(j=0;j<nq;j++)
	       for(l=0;l<nq;l++)
	       {
	         t[k][j]-=c[N-1][k][l]*c[i][l][j];
	         b[N-1][k][j]-=c[N-1][k][l]*a[i][l][j];
	       }
     for (k=0;k<nq;k++)  
	     for (j=0;j<nq;j++)  
	       f[N-1][k]-=c[N-1][k][j]*f[i][j];

     for(k=0;k<nq;k++)
	     for(j=0;j<nq;j++)
	       c[N-1][k][j]=t[k][j];
   }
      
   // decompose b(i) into L and U
   i=N-1;
   b11=1./b[i][0][0];
   u12=b[i][0][1]*b11;
   u13=b[i][0][2]*b11;
   u14=b[i][0][3]*b11;
   u15=b[i][0][4]*b11;
   b21=b[i][1][0];
   b22=1./(b[i][1][1]-b21*u12);
   u23=(b[i][1][2]-b21*u13)*b22;
   u24=(b[i][1][3]-b21*u14)*b22;
   u25=(b[i][1][4]-b21*u15)*b22;
   b31=b[i][2][0];
   b32=b[i][2][1]-b31*u12;
   b33=1./(b[i][2][2]-b31*u13-b32*u23);
   u34=(b[i][2][3]-b31*u14-b32*u24)*b33;
   u35=(b[i][2][4]-b31*u15-b32*u25)*b33;
   b41=b[i][3][0];
   b42=b[i][3][1]-b41*u12;
   b43=b[i][3][2]-b41*u13-b42*u23;
   b44=1./(b[i][3][3]-b41*u14-b42*u24-b43*u34);
   u45=(b[i][3][4]-b41*u15-b42*u25-b43*u35)*b44;
   b51=b[i][4][0];
   b52=b[i][4][1]-b51*u12;
   b53=b[i][4][2]-b51*u13-b52*u23;
   b54=b[i][4][3]-b51*u14-b52*u24-b53*u34;
   b55=1./(b[i][4][4]-b51*u15-b52*u25-b53*u35-b54*u45);
   //f(i) = Inv(b(i))* f(i)
   d1=f[i][0]*b11;
   d2=(f[i][1]-b21*d1)*b22;
   d3=(f[i][2]-b31*d1-b32*d2)*b33;
   d4=(f[i][3]-b41*d1-b42*d2-b43*d3)*b44;
   d5=(f[i][4]-b51*d1-b52*d2-b53*d3-b54*d4)*b55;
   
   f[i][4]=d5;
   f[i][3]=d4-u45*d5;
   f[i][2]=d3-u34*f[i][3]-u35*d5;
   f[i][1]=d2-u23*f[i][2]-u24*f[i][3]-u25*d5;
   f[i][0]=d1-u12*f[i][1]-u13*f[i][2]-u14*f[i][3]-u15*d5;
      
   //backward sweep
   i=N-2;
   for (k=0;k<nq;k++)  
     for (j=0;j<nq;j++) 
       f[i][k]-=(c[i][k][j]*f[i+1][j]);

   //backward sweep
   for (i=N-3;i>=0;i--)  
   {
      // f(i) = f(i) - c(i+1)*f(i+1)
      for (k=0;k<nq;k++)  
      {
         for (j=0;j<nq;j++)  
         {
	         f[i][k]-=(c[i][k][j]*f[i+1][j]+a[i][k][j]*f[N-1][j]);
         }
      }     
   }
}
//tridiagonal block inversion
// nq = 4
void blockTridag4(REAL ***a,REAL ***b, REAL ***c,REAL **f, int N,int nq)  
{
   int i,j,k,l;
   REAL b11,b21,b22,b31,b32,b33,b41,b42,b43,b44;
   REAL u12,u13,u14,u23,u24,u34,u44;
   REAL d1,d2,d3,d4;
   REAL c1,c2,c3,c4;
   REAL t[4][4];
   i=0;
   for (i=0;i<N;i++)  {
      if (i!=0) {
         // b(i) = b(i) - a(i)*c(i-1)
         for (k=0;k<nq;k++)  {
            for (j=0;j<nq;j++)  {
	       for (l=0;l<nq;l++)  {
                  b[i][k][j]-=a[i][k][l]*c[i-1][l][j];
	       }
            }
         }
         // f(i) = f(i) - a(i-1)*f(i-1)
         for (k=0;k<nq;k++)  {
            for (j=0;j<nq;j++)  {
               f[i][k]-=a[i][k][j]*f[i-1][j];
            }
         }
      }
      // decompose b(i) into L and U
      b11=1./b[i][0][0];
      u12=b[i][0][1]*b11;
      u13=b[i][0][2]*b11;
      u14=b[i][0][3]*b11;
      b21=b[i][1][0];
      b22=1./(b[i][1][1]-b21*u12);
      u23=(b[i][1][2]-b21*u13)*b22;
      u24=(b[i][1][3]-b21*u14)*b22;
      b31=b[i][2][0];
      b32=b[i][2][1]-b31*u12;
      b33=1./(b[i][2][2]-b31*u13-b32*u23);
      u34=(b[i][2][3]-b31*u14-b32*u24)*b33;
      b41=b[i][3][0];
      b42=b[i][3][1]-b41*u12;
      b43=b[i][3][2]-b41*u13-b42*u23;
      b44=1./(b[i][3][3]-b41*u14-b42*u24-b43*u34);
      //f(i) = Inv(b(i))* f(i)
      d1=f[i][0]*b11;
      d2=(f[i][1]-b21*d1)*b22;
      d3=(f[i][2]-b31*d1-b32*d2)*b33;
      d4=(f[i][3]-b41*d1-b42*d2-b43*d3)*b44;

      f[i][3]=d4;
      f[i][2]=d3-u34*f[i][3];
      f[i][1]=d2-u23*f[i][2]-u24*f[i][3];
      f[i][0]=d1-u12*f[i][1]-u13*f[i][2]-u14*f[i][3];

      if (i!=N-1) {
      // c(i) =  Inv(b(i)) *c(i)
         for (j=0;j<nq;j++)  {
	    c1=c[i][0][j]*b11;
	    c2=(c[i][1][j]-b21*c1)*b22;
	    c3=(c[i][2][j]-b31*c1-b32*c2)*b33;
	    c4=(c[i][3][j]-b41*c1-b42*c2-b43*c3)*b44;

	    c[i][3][j]=c4;
	    c[i][2][j]=c3-u34*c[i][3][j];
	    c[i][1][j]=c2-u23*c[i][2][j]-u24*c[i][3][j];
	    c[i][0][j]=c1-u12*c[i][1][j]-u13*c[i][2][j]-u14*c[i][3][j];
         }
      }
   }
   //backward sweep
   for (i=N-2;i>=0;i--)  {
      // f(i) = f(i) - c(i+1)*f(i+1)
      for (k=0;k<nq;k++)  {
         for (j=0;j<nq;j++)  {
            f[i][k]-=c[i][k][j]*f[i+1][j];
         }
      }
   }
}
//tridiagonal block inversion
// nq = 4
void blockTridagPeriodic4(REAL ***a,REAL ***b, REAL ***c,REAL **f, int N,int nq)  
{
   int i,j,k,l;
   REAL b11,b21,b22,b31,b32,b33,b41,b42,b43,b44;
   REAL u12,u13,u14,u23,u24,u34,u44;
   REAL d1,d2,d3,d4;
   REAL c1,c2,c3,c4;
   REAL a1,a2,a3,a4;
   REAL t[4][4];
   i=0;
   for (i=0;i<N;i++)  {
      if (i!=0) {
         // b(i) = b(i) - a(i)*c(i-1)
         for (k=0;k<nq;k++)  {
            for (j=0;j<nq;j++)  {
	       for (l=0;l<nq;l++)  {
                  b[i][k][j]-=a[i][k][l]*c[i-1][l][j];
	       }
            }
         }
         // f(i) = f(i) - a(i)*f(i-1)
         for (k=0;k<nq;k++)  {
            for (j=0;j<nq;j++)  {
               f[i][k]-=a[i][k][j]*f[i-1][j];
            }
         }

	 for(k=0;k<nq;k++)
	   for(j=0;j<nq;j++)
	     t[k][j]=0;
	 // a(i) = -a(i)*a(i-1)
	 for(k=0;k<nq;k++){
	   for(j=0;j<nq;j++){
	     for(l=0;l<nq;l++){
	       t[k][j]-=a[i][k][l]*a[i-1][l][j];
	     }
	   }
	 }

	 for(k=0;k<nq;k++)
	   for(j=0;j<nq;j++)
	     a[i][k][j]=t[k][j];	 
      }
      // decompose b(i) into L and U
      b11=1./b[i][0][0];
      u12=b[i][0][1]*b11;
      u13=b[i][0][2]*b11;
      u14=b[i][0][3]*b11;
      b21=b[i][1][0];
      b22=1./(b[i][1][1]-b21*u12);
      u23=(b[i][1][2]-b21*u13)*b22;
      u24=(b[i][1][3]-b21*u14)*b22;
      b31=b[i][2][0];
      b32=b[i][2][1]-b31*u12;
      b33=1./(b[i][2][2]-b31*u13-b32*u23);
      u34=(b[i][2][3]-b31*u14-b32*u24)*b33;
      b41=b[i][3][0];
      b42=b[i][3][1]-b41*u12;
      b43=b[i][3][2]-b41*u13-b42*u23;
      b44=1./(b[i][3][3]-b41*u14-b42*u24-b43*u34);
      //f(i) = Inv(b(i))* f(i)
      d1=f[i][0]*b11;
      d2=(f[i][1]-b21*d1)*b22;
      d3=(f[i][2]-b31*d1-b32*d2)*b33;
      d4=(f[i][3]-b41*d1-b42*d2-b43*d3)*b44;

      f[i][3]=d4;
      f[i][2]=d3-u34*f[i][3];
      f[i][1]=d2-u23*f[i][2]-u24*f[i][3];
      f[i][0]=d1-u12*f[i][1]-u13*f[i][2]-u14*f[i][3];

      if (i!= N-2) {
        // c(i) =  Inv(b(i)) *c(i)
	// a(i) = Inv(b(i))*a(i)
         for (j=0;j<nq;j++)  {
	    c1=c[i][0][j]*b11;
	    c2=(c[i][1][j]-b21*c1)*b22;
	    c3=(c[i][2][j]-b31*c1-b32*c2)*b33;
	    c4=(c[i][3][j]-b41*c1-b42*c2-b43*c3)*b44;

	    c[i][3][j]=c4;
	    c[i][2][j]=c3-u34*c[i][3][j];
	    c[i][1][j]=c2-u23*c[i][2][j]-u24*c[i][3][j];
	    c[i][0][j]=c1-u12*c[i][1][j]-u13*c[i][2][j]-u14*c[i][3][j];
	    
	    a1=a[i][0][j]*b11;
	    a2=(a[i][1][j]-b21*a1)*b22;
	    a3=(a[i][2][j]-b31*a1-b32*a2)*b33;
	    a4=(a[i][3][j]-b41*a1-b42*a2-b43*a3)*b44;

	    a[i][3][j]=a4;
	    a[i][2][j]=a3-u34*a[i][3][j];
	    a[i][1][j]=a2-u23*a[i][2][j]-u24*a[i][3][j];
	    a[i][0][j]=a1-u12*a[i][1][j]-u13*a[i][2][j]-u14*a[i][3][j];
         }
      }
      if (i==N-2) {
	for(k=0;k<nq;k++)
	  for(j=0;j<nq;j++)
	    c[i][j][k]+=a[i][j][k];
	for (j=0;j<nq;j++)  {
	    c1=c[i][0][j]*b11;
	    c2=(c[i][1][j]-b21*c1)*b22;
	    c3=(c[i][2][j]-b31*c1-b32*c2)*b33;
	    c4=(c[i][3][j]-b41*c1-b42*c2-b43*c3)*b44;

	    c[i][3][j]=c4;
	    c[i][2][j]=c3-u34*c[i][3][j];
	    c[i][1][j]=c2-u23*c[i][2][j]-u24*c[i][3][j];
	    c[i][0][j]=c1-u12*c[i][1][j]-u13*c[i][2][j]-u14*c[i][3][j];
	 }
	for(k=0;k<nq;k++)
	  for(j=0;j<nq;j++)
	    a[i][k][j]=c[i][k][j];
      }
   }

   i=N-1;
   for (k=0;k<nq;k++){
     for (j=0;j<nq;j++){
       if (j==k){
	 b[i][j][k]=1.0;
       }
       else{
	 b[i][j][k]=0.0;
       } 
     }
   }

   for(i=0;i<N-1;i++)
     {
       for(k=0;k<nq;k++)
	 for(j=0;j<nq;j++)
	   t[k][j]=0;

       for(k=0;k<nq;k++)
	 for(j=0;j<nq;j++)
	   for(l=0;l<nq;l++)
	     {
	       t[k][j]-=c[N-1][k][l]*c[i][l][j];
	       b[N-1][k][j]-=c[N-1][k][l]*a[i][l][j];
	     }
       for (k=0;k<nq;k++)  
	 for (j=0;j<nq;j++)  
	   f[N-1][k]-=c[N-1][k][j]*f[i][j];

       for(k=0;k<nq;k++)
	 for(j=0;j<nq;j++)
	   c[N-1][k][j]=t[k][j];
     }
   //
   // decompose b(i) into L and U
   //
   i=N-1;
   b11=1./b[i][0][0];
   u12=b[i][0][1]*b11;
   u13=b[i][0][2]*b11;
   u14=b[i][0][3]*b11;
   b21=b[i][1][0];
   b22=1./(b[i][1][1]-b21*u12);
   u23=(b[i][1][2]-b21*u13)*b22;
   u24=(b[i][1][3]-b21*u14)*b22;
   b31=b[i][2][0];
   b32=b[i][2][1]-b31*u12;
   b33=1./(b[i][2][2]-b31*u13-b32*u23);
   u34=(b[i][2][3]-b31*u14-b32*u24)*b33;
   b41=b[i][3][0];
   b42=b[i][3][1]-b41*u12;
   b43=b[i][3][2]-b41*u13-b42*u23;
   b44=1./(b[i][3][3]-b41*u14-b42*u24-b43*u34);
   //f(i) = Inv(b(i))* f(i)
   d1=f[i][0]*b11;
   d2=(f[i][1]-b21*d1)*b22;
   d3=(f[i][2]-b31*d1-b32*d2)*b33;
   d4=(f[i][3]-b41*d1-b42*d2-b43*d3)*b44;
   
   f[i][3]=d4;
   f[i][2]=d3-u34*f[i][3];
   f[i][1]=d2-u23*f[i][2]-u24*f[i][3];
   f[i][0]=d1-u12*f[i][1]-u13*f[i][2]-u14*f[i][3];
      
   //backward sweep
   i=N-2;
   for (k=0;k<nq;k++)  
     for (j=0;j<nq;j++) 
       f[i][k]-=(c[i][k][j]*f[i+1][j]);

   //backward sweep
   for (i=N-3;i>=0;i--)  {
      // f(i) = f(i) - c(i+1)*f(i+1)
      for (k=0;k<nq;k++)  {
         for (j=0;j<nq;j++)  {
	   f[i][k]-=(c[i][k][j]*f[i+1][j]+a[i][k][j]*f[N-1][j]);
         }
      }     
   }
}
